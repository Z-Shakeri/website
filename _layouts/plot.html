---
layout: default
---

{% assign plots_type = page.plots | to_plots_type %}

<div class="page plot-page">

    <p class="paper-info">
        The visualizations and data on this page are from our publication "International electronic health record driven COVID-19 clinical course profile" (see <a href="https://www.medrxiv.org/">medRxiv preprint</a>).
    </p>

    <div class="plot-page-container">
        <p class="title">{{ page.title }}</p>
        <p class="subtitle">{{ page.subtitle }}</p>

        <div class="inner">
            <!-- Top-right buttons -->
            <div class="top-actions">
                <a 
                    href="https://github.com/hms-dbmi/c19i2b2-notebooks/blob/master/notebooks/{{ page.notebook }}" 
                    target="_blank"
                >
                    View Jupyter Notebook
                </a>
            </div>

            <!-- Tabs (if applicable) -->
            {% comment %}
            {% if plots_type == "hash" %}
                <div class="tabs">
                    {% for tab in page.plots %}
                        <div 
                            class="tab" 
                            id="tab_{{ tab[0] | slugify }}"
                        >
                            {{ tab[0] }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            {% endcomment %}
            
            <!-- Plots -->
            <div class="plot-wrapper">
                {% if plots_type == "hash" %}
                    <!-- Tabbed plots -->
                    {% for tab in page.plots %}
                        <!-- Content for a single tab -->
                        <div 
                            class="tab-content"
                            id="tab_content_{{ tab[0] | slugify }}">
                            <div class="plot-list">
                                <!--Vertically stacked plots within a tab -->
                                {% for plot in tab[1] %}
                                    <!-- Content for a single plot -->
                                    {% assign plot_type = plot | to_plot_type %}
                                    <div class="{{ plot_type }}-plot-container">
                                        <div 
                                            id="{{ plot | to_plot_id }}" 
                                            class="{{ plot_type }}-plot-item"
                                        >
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- Non-tabbed (vertically stacked) plots -->
                    {% for plot in page.plots %}
                        <!-- Content for a single plot -->
                        {% assign plot_type = plot | to_plot_type %}
                        <div class="{{ plot_type }}-plot-container">
                            <div 
                                id="{{ plot | to_plot_id }}" 
                                class="{{ plot_type }}-plot-item"
                            >
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="description">
                {{ content }}
            </div>
        </div>
    </div>

    <h3>Source Code</h3>
    <p>
        The code used to generate the plots on this page is available in the 
        <a href="https://github.com/hms-dbmi/c19i2b2-notebooks">covidclinical/notebooks</a>
        and 
        <a href="https://github.com/covidclinical/website">covidclinical/website</a>
        GitHub repositories.
    </p>

</div>

<!-- External -->
<script src="https://unpkg.com/mithril/mithril.js"></script>
<script type="text/javascript" src="{{ "/assets/js/vega.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/vega-lite.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/vega-embed.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/d3-fetch.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/lineup.js" | relative_url }}"></script>

<!-- Plots -->
<script type="text/javascript">

    const plotsType = "{{ plots_type }}";
    const allPlots = {{ page.plots | jsonify }};
    const pageUrl = "{{ page.url | relative_url }}";

    function toPlotType(plotPath) {
        return plotPath.substring(0, plotPath.indexOf('/'));
    }

    function toPlotId(plotPath) {
        return plotPath.replace("/", "_").replace(".", "_");
    }

    function toPlotUrl(plotPath) {
        const relativeUrl = pageUrl.substring(0, pageUrl.lastIndexOf('/'));
        return `${relativeUrl}/${plotPath}`;
    }

    function lineupEmbed(selector, fileUrl, options) {
        const el = document.querySelector(selector);

        d3.json(fileUrl).then(function(data) {
            const lineup = LineUpJS.asLineUp(el, data);
        });
    }

    const toEmbedFunction = {
        vega: vegaEmbed,
        lineup: lineupEmbed
    };

    function renderPlots(plots) {
        for(let plotPath of plots) {
            const plotType = toPlotType(plotPath);
            const plotEmbed = toEmbedFunction[plotType];
            const plotUrl = toPlotUrl(plotPath);
            const plotId = toPlotId(plotPath);
            plotEmbed(
                `#${plotId}`,
                plotUrl,
                {
                    renderer: "canvas",
                    downloadFileName: `4CE-COVID-19_${plotId}`,
                    actions: {
                        export: true,
                        editor: false,
                        compiled: false,
                        source: true,
                    }
                }
            );
        }
    }

    function plotsInit() {
        if(plotsType === "hash") {
            let firstTabPlots = Object.entries(allPlots)[0][1];
            renderPlots(firstTabPlots);
        } else {
            renderPlots(allPlots);
        }
    }

    window.onload = plotsInit;


  /*  const expandButton = document.querySelector('#expand-width');
    expandButton.addEventListener('click', () => {
        const wrapper = document.querySelector('.page-content .wrapper');

        if(wrapper) {
            wrapper.classList.toggle("wrapper-wide");
            renderPlots();

            if(wrapper.classList.contains("wrapper-wide")) {
                expandButton.innerHTML = "Minimize";
            } else {
                expandButton.innerHTML = "Expand";
            }
        }
    });*/
</script>