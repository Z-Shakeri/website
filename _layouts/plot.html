---
layout: default
---

{% assign plots_type = page.plots | to_plots_type %}

<div class="page plot-page">

    <p class="paper-info">
        The visualizations on this page are from our publication "International electronic health record driven COVID-19 clinical course profile" (see <a href="https://www.medrxiv.org/">medRxiv preprint</a>).
    </p>

    <div class="plot-page-container">
        <p class="title">{{ page.title }}</p>
        <p class="subtitle">{{ page.subtitle }}</p>

        <div class="inner">
            <div class="top-actions">
                <a 
                    href="https://github.com/hms-dbmi/c19i2b2-notebooks/blob/master/notebooks/{{ page.notebook }}" 
                    target="_blank"
                >
                    View Jupyter Notebook
                </a>
            </div>

            <div id="m-plots"></div>

            <div class="description">
                {{ content }}
            </div>
        </div>
    </div>

    <h3>Source Code</h3>
    <p>
        The code used to generate the plots on this page is available in the 
        <a href="https://github.com/hms-dbmi/c19i2b2-notebooks">covidclinical/notebooks</a>
        and 
        <a href="https://github.com/covidclinical/website">covidclinical/website</a>
        GitHub repositories.
    </p>

</div>

<!-- External -->
<script type="text/javascript" src="{{ "/assets/js/mithril.min.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/vega.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/vega-lite.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/vega-embed.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/d3-fetch.js" | relative_url }}"></script>
<script type="text/javascript" src="{{ "/assets/js/lineup.js" | relative_url }}"></script>

<!-- Plots -->
<script type="text/javascript">

    // Global variables.
    const plotsType = "{{ plots_type }}";
    const allPlots = {{ page.plots | jsonify }};
    const pageUrl = "{{ page.url | relative_url }}";

    const vegaLabelMap = new Map(Object.entries({
        "Lab_loinc_name": "Lab LOINC Name",
        "Value_category": "Value category",
        "new_positive_cases": "New positive cases",
        "new_deaths": "New deaths",
        "patients_in_icu": "Patients in ICU",
        "Country_siteid": "Country",
        "Sex_sex": "Sex"
    }));

    let currTab;

    // Helper functions.
    function toPlotType(plotPath) {
        return plotPath.substring(0, plotPath.indexOf('/'));
    }

    function toPlotId(plotPath) {
        return plotPath.replace("/", "_").replace(".", "_");
    }

    function toPlotUrl(plotPath) {
        const relativeUrl = pageUrl.substring(0, pageUrl.lastIndexOf('/'));
        return `${relativeUrl}/${plotPath}`;
    }

    function lineupEmbed(selector, fileUrl, options) {
        const el = document.querySelector(selector);

        d3.json(fileUrl).then(function(data) {
            const lineup = LineUpJS.asLineUp(el, data);
        });
    }

    const toEmbedFunction = {
        vega: vegaEmbed,
        lineup: lineupEmbed
    };

    function fixVegaText() {
        const vegaBindEls = document.querySelectorAll(".vega-bind");
        for(let vegaBindEl of vegaBindEls) {
            const spanEls = Array.from(vegaBindEl.querySelectorAll('.vega-bind-name'));
            const optionEls = Array.from(vegaBindEl.querySelectorAll('select > option'));
            const els = spanEls.concat(optionEls);
            for(let el of els) {
                const content = el.innerHTML;
                if(vegaLabelMap.has(content)) {
                    const newContent = vegaLabelMap.get(content);
                    el.innerHTML = newContent;
                }
            }
        }
    }
    
    // Components.
    const PlotComponent = {
        oncreate: (vnode) => {
            const plotPath = vnode.attrs.plotPath;
            const plotEmbed = toEmbedFunction[toPlotType(plotPath)];
            const plotUrl = toPlotUrl(plotPath);
            const plotId = toPlotId(plotPath);
            const result = plotEmbed(
                `#${plotId}`,
                plotUrl,
                {
                    downloadFileName: `4CE-COVID-19_${plotId}`,
                    renderer: "canvas",
                    actions: false
                }
            );

            if(result && result.then) {
                result.then(() => {
                    fixVegaText();
                });
            }
        },
        view: (vnode) => {
            const plotPath = vnode.attrs.plotPath;
            const plotType = toPlotType(plotPath);
            const plotId = toPlotId(plotPath);
            return m("div", { class:  `${plotType}-plot-container` }, 
                m("div", { class: "plot-item", id: plotId })
            );
        }
    };

    const ListComponent = {
        view: (vnode) => {
            return m("div", { class: "plot-list" }, 
                vnode.attrs.plots.map(plotPath => m(PlotComponent, { plotPath, key: plotPath }))
            );
        }
    };

    const TabComponent = {
        view: (vnode) => {
            const tab = vnode.attrs.tab;
            const currTab = vnode.attrs.currTab;
            const onTabClick = () => {
                vnode.attrs.onTabClick(tab);
            };
            return m("div", { class: `tab ${tab === currTab ? "active" : ""}`, onclick: onTabClick }, tab);
        }
    };

    const TabNavComponent = {
        view: (vnode) => {
            return m("div", { class: "tabs" }, vnode.attrs.tabs.map(
                d => m(TabComponent, { tab: d, currTab: vnode.attrs.currTab, onTabClick: vnode.attrs.onTabClick })
            ));
        }
    };

    const TabContentComponent = {
        view: function(vnode) {
            return m("div", { class: "tab-content" }, m(ListComponent, { plots: allPlots[vnode.attrs.currTab] }));
        }
    };

    const tabs = Object.keys(allPlots);
    
    const TabsComponent = {
        setCurrTab: function(newTab) {
            currTab = newTab;
        },
        view: function(vnode) {
            return m("div", [ m(TabNavComponent, { currTab, tabs, onTabClick: this.setCurrTab }), m(TabContentComponent, { currTab }) ]);
        }
    };

    // Initialization.
    window.onload = () => {
        const mPlotsDiv = document.querySelector("#m-plots");

        if(plotsType === "hash") {
            currTab = tabs[0];
            m.mount(mPlotsDiv, TabsComponent);
        } else {
            m.render(mPlotsDiv, m(ListComponent, { plots: allPlots }));
        }
    };


  /*  const expandButton = document.querySelector('#expand-width');
    expandButton.addEventListener('click', () => {
        const wrapper = document.querySelector('.page-content .wrapper');

        if(wrapper) {
            wrapper.classList.toggle("wrapper-wide");
            renderPlots();

            if(wrapper.classList.contains("wrapper-wide")) {
                expandButton.innerHTML = "Minimize";
            } else {
                expandButton.innerHTML = "Expand";
            }
        }
    });*/
</script>